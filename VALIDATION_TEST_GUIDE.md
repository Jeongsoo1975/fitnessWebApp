# 회원 검증 시스템 테스트 가이드

## 개요
새로 구현된 Clerk 사용자 검증 시스템의 종단간 테스트를 위한 가이드입니다.

## 테스트 시나리오

### 1. 존재하지 않는 이메일 검색 테스트

**목적**: 실제로 등록되지 않은 이메일로 검색 시 적절한 안내 메시지가 표시되는지 확인

**테스트 단계**:
1. 트레이너 계정으로 로그인
2. 회원 검색 페이지 (`/trainer/member-search`) 접속
3. 존재하지 않는 이메일 입력 (예: `nonexistent@test.com`)
4. 검색 실행

**예상 결과**:
- 빈 검색 결과
- 메시지: "해당 이메일로 등록된 사용자를 찾을 수 없습니다. 올바른 이메일 주소인지 확인해주세요."
- 등록 요청 버튼이 비활성화되거나 표시되지 않음

### 2. 실제 존재하는 이메일 검색 테스트

**목적**: 실제 등록된 사용자 이메일로 검색 시 올바른 정보가 표시되는지 확인

**사전 준비**:
- 다른 브라우저/시크릿 모드에서 회원 계정 생성
- 회원 계정의 이메일 주소 확인

**테스트 단계**:
1. 트레이너 계정으로 로그인
2. 회원 검색 페이지 접속
3. 실제 존재하는 회원 이메일 입력
4. 검색 실행

**예상 결과**:
- 검색 결과에 실제 사용자 정보 표시
- 메시지: "검색 결과를 찾았습니다."
- 등록 요청 버튼 활성화

### 3. 자기 자신 이메일 검색 테스트

**목적**: 트레이너가 자신의 이메일로 검색 시 적절한 차단이 되는지 확인

**테스트 단계**:
1. 트레이너 계정으로 로그인
2. 회원 검색 페이지 접속
3. 본인의 이메일 주소 입력
4. 검색 실행

**예상 결과**:
- 빈 검색 결과
- 메시지: "자신의 이메일로는 검색할 수 없습니다."

### 4. 존재하지 않는 사용자에게 등록 요청 시도 테스트

**목적**: API 레벨에서 존재하지 않는 사용자에 대한 요청이 차단되는지 확인

**테스트 방법** (개발자 도구 사용):
1. 브라우저 개발자 도구 열기
2. Console에서 다음 코드 실행:
```javascript
fetch('/api/trainer/member-request', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    memberId: 'fake@email.com',
    memberEmail: 'fake@email.com',
    message: 'Test message'
  })
}).then(r => r.json()).then(console.log)
```

**예상 결과**:
- HTTP Status: 404
- 응답: `{ error: "User not found", message: "해당 이메일로 등록된 사용자를 찾을 수 없습니다..." }`

### 5. 정상적인 등록 요청 프로세스 테스트

**목적**: 전체 워크플로우가 올바르게 작동하는지 확인

**테스트 단계**:
1. **트레이너 계정** (창 1):
   - 실제 존재하는 회원 이메일로 검색
   - 등록 요청 전송
   
2. **회원 계정** (창 2):
   - `/member/notifications` 페이지 접속
   - 받은 요청 확인
   - 요청 승인
   
3. **트레이너 계정** (창 1):
   - `/trainer/dashboard` 또는 `/trainer/members` 페이지 새로고침
   - 승인된 회원이 목록에 표시되는지 확인

**예상 결과**:
- 각 단계에서 적절한 성공 메시지
- 최종적으로 트레이너 대시보드에 새 회원 표시

## API 응답 형식

### 검색 API (`/api/trainer/member-search`)
```json
{
  "success": true,
  "members": [...],
  "count": 0,
  "message": "사용자 친화적 메시지"
}
```

### 요청 생성 API (`/api/trainer/member-request`)
```json
{
  "success": true,
  "requestId": "...",
  "message": "Member request sent successfully",
  "memberInfo": {
    "id": "...",
    "name": "...",
    "email": "..."
  }
}
```

## 에러 케이스별 응답

### 404 - 사용자 없음
```json
{
  "error": "User not found",
  "message": "해당 이메일로 등록된 사용자를 찾을 수 없습니다. 올바른 이메일 주소인지 확인해주세요."
}
```

### 400 - 잘못된 요청
```json
{
  "error": "Invalid request",
  "message": "자기 자신에게는 등록 요청을 보낼 수 없습니다."
}
```

### 409 - 중복 요청
```json
{
  "error": "Duplicate request",
  "message": "이미 해당 회원에게 대기 중인 요청이 있습니다."
}
```

## 보안성 검증 포인트

1. ✅ **사용자 존재 검증**: 실제 Clerk에 등록된 사용자만 검색 가능
2. ✅ **이중 검증**: 검색 + 요청 생성 단계에서 각각 검증
3. ✅ **자기 요청 방지**: 트레이너가 자신에게 요청 불가
4. ✅ **입력값 검증**: 이메일 형식 및 필수 필드 검증
5. ✅ **오류 처리**: 각 오류 상황별 적절한 응답

## 성능 고려사항

- Clerk API 호출 최소화를 위한 이메일 형식 사전 검증
- 검증 실패 시 빠른 응답으로 사용자 대기 시간 최소화
- 적절한 타임아웃 설정으로 무한 대기 방지

## 로깅 및 디버깅

모든 검증 과정은 개발 환경에서 상세한 로그를 제공합니다:
- `[member-search]` 접두사로 검색 과정 추적
- `[member-request]` 접두사로 요청 생성 과정 추적
- `[validateUserByEmail]` 접두사로 Clerk API 호출 추적
